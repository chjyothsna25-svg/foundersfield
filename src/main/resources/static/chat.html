<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat - Founders Field</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<style>
  body { font-family: 'Segoe UI', sans-serif; background:#f8f9fa; margin:0; padding:0; }
  .chat-container { display:flex; height:90vh; max-height:90vh; }
  .sidebar { width:300px; border-right:1px solid #ddd; overflow-y:auto; background:white; }
  .chat-window { flex:1; padding:10px; display:flex; flex-direction:column; justify-content:flex-end; overflow-y:auto; }
  .chat-user { padding:10px; border-bottom:1px solid #eee; cursor:pointer; }
  .chat-user:hover { background:#f1f1f1; }
  .message { margin:5px 0; max-width:70%; padding:6px 10px; border-radius:10px; display:inline-block; }
  .message.sent { background:#007bff; color:white; align-self:flex-end; }
  .message.received { background:#f1f1f1; color:black; align-self:flex-start; }
  .chat-input { display:flex; border-top:1px solid #ddd; background:white; padding:10px; }
  .chat-input input { flex:1; padding:8px 12px; border-radius:20px; border:1px solid #ccc; outline:none; }
  .chat-input button { margin-left:10px; padding:8px 14px; border:none; border-radius:20px; background:#007bff; color:white; cursor:pointer; }
  .chat-input button:hover { background:#0056b3; }
</style>
</head>
<body>

<header class="bg-gray-800 text-white text-center py-4 text-xl font-semibold">ðŸ’¬ Chat - Founders Field</header>

<div class="chat-container">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <p class="text-center text-gray-500 mt-5">Select a user to chat</p>
  </div>

  <!-- Chat window -->
  <div class="chat-window" id="chatWindow">
    <p class="text-center text-gray-400">No conversation selected</p>
  </div>
</div>

<!-- Input -->
<div class="chat-input">
  <input type="text" id="messageInput" placeholder="Type a message..." disabled>
  <button id="sendBtn" disabled>Send</button>
</div>

<script>
let selectedUserId = null;
let currentUserId = null;
let stompClient = null;

// Get logged in user
async function getCurrentUser() {
    try {
        const res = await fetch('/api/auth/me', { credentials:'include' });
        if(!res.ok) throw new Error('Not logged in');
        const user = await res.json();
        currentUserId = user.id;
    } catch(err) {
        alert('Please log in to use chat!');
        window.location.href = '/login.html';
    }
}

// Load selected user from localStorage
function loadSelectedUser() {
    selectedUserId = localStorage.getItem('chatUserId');
    const selectedUserName = localStorage.getItem('chatUserName');
    const sidebar = document.getElementById('sidebar');

    if(selectedUserId && selectedUserName) {
        sidebar.innerHTML = `<div class="chat-user" data-id="${selectedUserId}">
            <strong>${selectedUserName}</strong>
        </div>`;
        document.querySelector('.chat-user').addEventListener('click', () => {
            loadChatHistory(selectedUserId);
        });
        loadChatHistory(selectedUserId);
    }
}

// Fetch chat history
async function loadChatHistory(userId) {
    try {
        const res = await fetch(`/api/messages/history/${userId}`, { credentials:'include' });
        if(!res.ok) throw new Error('Failed to load messages');
        const messages = await res.json();

        const chatWindow = document.getElementById('chatWindow');
        chatWindow.innerHTML = '';
        if(messages.length === 0) {
            chatWindow.innerHTML = `<p class="text-center text-gray-400 mt-5">No messages yet</p>`;
        } else {
            messages.forEach(msg => appendMessage(msg));
        }

        // Enable input
        document.getElementById('messageInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;
    } catch(err) {
        document.getElementById('chatWindow').innerHTML = `<p class="text-center text-red-500 mt-5">${err.message}</p>`;
    }
}

// Append message to chat window
function appendMessage(message) {
    const chatWindow = document.getElementById('chatWindow');
    const div = document.createElement('div');
    div.classList.add('message');
    div.classList.add(message.sender.id === currentUserId ? 'sent' : 'received');
    div.innerText = message.content;
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

// Connect WebSocket
function connectWebSocket() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function(frame) {
        console.log('WebSocket Connected: ' + frame);

        // Subscribe to messages
        stompClient.subscribe('/topic/messages', function(messageOutput) {
            const message = JSON.parse(messageOutput.body);
            if ((message.sender.id == currentUserId && message.receiver.id == selectedUserId) ||
                (message.sender.id == selectedUserId && message.receiver.id == currentUserId)) {
                appendMessage(message);
            }
        });
    }, function(error) {
        console.error('STOMP error: ' + error);
    });
}

// Send message
function sendMessage() {
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    if(!content || !stompClient) return;

    const message = {
        receiverId: selectedUserId,
        content: content
    };

    stompClient.send("/app/sendMessage", {}, JSON.stringify(message));
    input.value = '';
}

// Event listeners
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('messageInput').addEventListener('keypress', e => {
    if(e.key === 'Enter') sendMessage();
});

// Initialize
getCurrentUser().then(() => {
    loadSelectedUser();
    connectWebSocket();
});
</script>

</body>
</html>

